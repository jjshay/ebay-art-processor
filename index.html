<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace Magic - AI Art Listing Generator</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        
        .panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .upload-area {
            border: 3px dashed rgba(0,255,136,0.5);
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0,255,136,0.02);
        }
        
        .upload-area:hover {
            border-color: #00ff88;
            background: rgba(0,255,136,0.05);
            transform: scale(1.01);
        }
        
        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-process {
            width: 100%;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #1a1a2e;
            margin-top: 20px;
        }
        
        .btn-process:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,255,136,0.4);
        }
        
        .btn-process:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin: 10px;
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
        }
        
        .btn-search {
            padding: 8px 16px;
            background: linear-gradient(135deg, #00ccff, #0099ff);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .btn-search:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,204,255,0.4);
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a2e;
            font-weight: bold;
            font-size: 18px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .results-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .results-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .editable {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(0,255,136,0.5);
            color: #00ff88;
            padding: 8px;
            border-radius: 5px;
            width: 100%;
        }
        
        .editable:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(255,255,255,0.15);
        }
        
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(0,255,136,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .thumbnail:hover {
            transform: scale(1.1);
            border-color: #00ff88;
            box-shadow: 0 5px 15px rgba(0,255,136,0.5);
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .message {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            font-size: 16px;
        }
        
        .message.success {
            background: rgba(0,255,136,0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            display: block;
        }
        
        .message.error {
            background: rgba(255,100,100,0.2);
            border: 1px solid #ff6464;
            color: #ff6464;
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #999;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .success-notice {
            background: linear-gradient(135deg, rgba(0,255,136,0.2), rgba(0,204,255,0.2));
            border: 2px solid #00ff88;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: #1a1a2e;
            margin: 20px auto;
            padding: 30px;
            border: 2px solid #00ff88;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,255,136,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0,255,136,0.3);
        }
        
        .modal-title {
            color: #00ff88;
            font-size: 24px;
            font-weight: bold;
        }
        
        .close-btn {
            color: #ff6464;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            color: #ff0000;
            transform: scale(1.2);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .detail-image {
            width: 100%;
            border-radius: 10px;
            border: 2px solid rgba(0,255,136,0.3);
        }
        
        .detail-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .field-group {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .field-label {
            color: #00ccff;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .field-value {
            color: #fff;
            font-size: 14px;
            word-break: break-word;
        }
        
        .field-count-badge {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #1a1a2e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✨ Marketplace Magic</h1>
        <div class="subtitle">AI-Powered Art Listings • 26 Auto-Fill Fields • Smart Renaming • Market Research</div>
        
        <div style="text-align: center; margin: 10px 0;">
            <button onclick="resetApiKey()" style="padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #999; border-radius: 5px; cursor: pointer; font-size: 12px;">
                🔑 Change API Key
            </button>
        </div>
        
        <div class="panel">
            <h2 style="color: #00ff88; margin-bottom: 20px;">📸 Step 1: Upload Artwork</h2>
            
            <div style="margin-bottom: 20px; padding: 20px; background: rgba(0,255,136,0.1); border-radius: 10px; border: 1px solid rgba(0,255,136,0.3);">
                <label style="color: #00ff88; font-weight: bold; display: block; margin-bottom: 10px;">
                    🎨 Override Artist Name (Optional):
                </label>
                <input type="text" 
                       id="artistOverride" 
                       placeholder="Leave blank for AI detection, or enter: Death NYC, Shepard Fairey, etc."
                       style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid rgba(0,255,136,0.5); color: #00ff88; border-radius: 8px; font-size: 16px;"
                       onchange="updateArtistOverride(this.value)">
                <small style="color: #999; display: block; margin-top: 5px;">
                    When filled, all images will use this artist name instead of AI detection
                </small>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
                <div style="font-size: 4em; margin-bottom: 15px;">🎨</div>
                <h3 style="color: #00ff88;">Drop Images Here or Click to Browse</h3>
                <p style="margin-top: 10px; color: #999;">Select Death NYC or Shepard Fairey artwork</p>
            </div>
            
            <div id="fileInfo" style="text-align: center; margin: 15px 0; font-size: 18px; color: #00ff88;"></div>
            
            <button class="btn-process" id="processBtn" onclick="processImages()" disabled>
                🤖 ANALYZE & GENERATE MARKETPLACE DATA
            </button>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>
        
        <div id="message" class="message"></div>
        
        <div class="panel" id="resultsSection" style="display:none;">
            <h2 style="color: #00ff88; margin-bottom: 20px;">📊 Step 2: Review & Export</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Images</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="deathCount">0</div>
                    <div class="stat-label">Death NYC</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="shepardCount">0</div>
                    <div class="stat-label">Shepard Fairey</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPrice">$0</div>
                    <div class="stat-label">Avg Price</div>
                </div>
            </div>
            
            <div class="success-notice">
                <h3 style="color: #00ff88; margin-bottom: 10px;">✅ Data Ready for Export!</h3>
                <p>26 marketplace fields auto-generated (original price, size, weight, dimensions are manual). You can edit any field below before exporting.</p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn-download" onclick="exportFullCSV()">
                    📊 DOWNLOAD CSV (34 Fields for Google Sheets)
                </button>
                <button class="btn-download" onclick="downloadRenamedImages()">
                    🖼️ DOWNLOAD RENAMED IMAGES
                </button>
                <button class="btn-download" onclick="copyToClipboard()">
                    📋 COPY DATA TO CLIPBOARD
                </button>
            </div>
            
            <h3 style="color: #00ccff; margin: 20px 0;">Preview & Edit:</h3>
            
            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>New Filename</th>
                            <th>Artist</th>
                            <th>Title</th>
                            <th>Price</th>
                            <th>Fields</th>
                            <th>Actions / Market Research</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Detail View Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Item Details - All 34 Fields</div>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <!-- Search Modal -->
    <div id="searchModal" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <div class="modal-title">🔍 Market Research</div>
                <span class="close-btn" onclick="closeSearchModal()">&times;</span>
            </div>
            <div id="searchModalBody"></div>
        </div>
    </div>
    
    <!-- Welcome/Setup Modal -->
    <div id="welcomeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);">
            <div style="text-align: center; padding: 20px;">
                <h1 style="color: #00ff88; font-size: 2.5em; margin-bottom: 20px;">✨ Welcome to Marketplace Magic!</h1>
                
                <div style="background: rgba(0,255,136,0.1); border: 2px solid #00ff88; border-radius: 15px; padding: 25px; margin: 20px 0;">
                    <h2 style="color: #00ff88; margin-bottom: 15px;">⚡ Quick Setup (One-Time Only)</h2>
                    <p style="color: #fff; font-size: 1.1em; line-height: 1.6;">
                        This tool uses Google's Gemini AI to identify artwork.<br>
                        You'll need a <strong style="color: #00ff88;">FREE API key</strong> that takes 30 seconds to get!
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 30px; margin: 20px 0;">
                    <h3 style="color: #00ccff; margin-bottom: 20px; font-size: 1.5em;">📋 Get Your Free API Key in 3 Steps:</h3>
                    
                    <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                        <div style="background: rgba(0,204,255,0.1); border-left: 4px solid #00ccff; padding: 15px; margin: 15px 0; border-radius: 5px;">
                            <strong style="color: #00ccff; font-size: 1.2em;">Step 1:</strong>
                            <p style="color: #fff; margin-top: 5px;">
                                Click this link to open Google AI Studio:<br>
                                <a href="https://makersuite.google.com/app/apikey" target="_blank" 
                                   style="color: #00ff88; font-weight: bold; text-decoration: underline;">
                                   🔗 makersuite.google.com/app/apikey
                                </a>
                            </p>
                        </div>
                        
                        <div style="background: rgba(0,204,255,0.1); border-left: 4px solid #00ccff; padding: 15px; margin: 15px 0; border-radius: 5px;">
                            <strong style="color: #00ccff; font-size: 1.2em;">Step 2:</strong>
                            <p style="color: #fff; margin-top: 5px;">
                                Sign in with your Google account<br>
                                <small style="color: #999;">(Any Gmail account works)</small>
                            </p>
                        </div>
                        
                        <div style="background: rgba(0,204,255,0.1); border-left: 4px solid #00ccff; padding: 15px; margin: 15px 0; border-radius: 5px;">
                            <strong style="color: #00ccff; font-size: 1.2em;">Step 3:</strong>
                            <p style="color: #fff; margin-top: 5px;">
                                Click "<strong>Create API Key</strong>" button<br>
                                <small style="color: #999;">It looks like: AIzaSy... (39 characters)</small>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(102,126,234,0.1); border: 2px solid #667eea; border-radius: 15px; padding: 25px; margin: 20px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">🔑 Enter Your API Key:</h3>
                    <input type="text" 
                           id="apiKeyInput" 
                           placeholder="Paste your API key here (starts with AIzaSy...)" 
                           style="width: 100%; padding: 15px; font-size: 16px; background: rgba(255,255,255,0.1); border: 2px solid #667eea; color: #fff; border-radius: 8px; margin-bottom: 15px;"
                           onkeypress="if(event.key === 'Enter') saveApiKey()">
                    <button onclick="saveApiKey()" 
                            style="padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(102,126,234,0.4)'" 
                            onmouseout="this.style.transform=''; this.style.boxShadow=''">
                        ✅ Save & Start Processing
                    </button>
                </div>
                
                <div style="background: rgba(255,255,255,0.03); border-radius: 10px; padding: 20px; margin-top: 20px;">
                    <p style="color: #999; font-size: 0.9em; line-height: 1.5;">
                        💡 <strong>Why do I need this?</strong> The AI that identifies Death NYC vs Shepard Fairey artwork needs an API key to work.<br>
                        🔒 <strong>Privacy:</strong> Your key is stored only in your browser, never sent anywhere else.<br>
                        💰 <strong>Cost:</strong> Google gives you <strong>FREE credits</strong> - enough for thousands of images!<br>
                        ⏱️ <strong>One-time setup:</strong> You'll never need to do this again on this device.
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="document.getElementById('welcomeModal').style.display='none'" 
                            style="padding: 10px 20px; background: transparent; border: 1px solid #666; color: #999; border-radius: 5px; cursor: pointer;">
                        Skip for now (won't work without key)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Gemini API key management
        let GEMINI_KEY = localStorage.getItem('gemini_key') || '';
        
        let selectedFiles = [];
        let processedData = [];
        let artistOverride = null;
        
        // Setup
        document.addEventListener('DOMContentLoaded', () => {
            console.log('✨ Marketplace Magic Ready!');
            
            // Check for API key on load
            if (!GEMINI_KEY) {
                showWelcomeModal();
            }
            
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                handleFileSelect(e.target.files);
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            });
        });
        
        function updateArtistOverride(value) {
            artistOverride = value.trim();
            if (artistOverride) {
                console.log(`Artist override set to: ${artistOverride}`);
                showMessage(`Artist set to: ${artistOverride} (will apply to all images)`, 'success');
            } else {
                console.log('Artist override cleared - will use AI detection');
            }
        }
        
        function handleFileSelect(files) {
            selectedFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            const fileInfo = document.getElementById('fileInfo');
            
            if (selectedFiles.length > 0) {
                fileInfo.textContent = `✅ ${selectedFiles.length} images ready to process`;
                document.getElementById('processBtn').disabled = false;
            } else {
                fileInfo.textContent = '';
                document.getElementById('processBtn').disabled = true;
            }
        }
        
        async function processImages() {
            if (selectedFiles.length === 0) return;
            
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            processedData = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                updateProgress((i / selectedFiles.length) * 100, `Processing ${file.name}...`);
                
                try {
                    const base64 = await imageToBase64(file);
                    
                    // Always analyze image to get subject, colors, etc.
                    let analysis = await analyzeWithGemini(base64);
                    
                    // Override artist if specified
                    if (artistOverride && artistOverride.trim() !== '') {
                        analysis.artist = artistOverride;
                        console.log(`Artist override: ${artistOverride}, detected subject: ${analysis.subject}`);
                    }
                    
                    // Try OpenAI enhancement if key available
                    if (OPENAI_KEY && analysis.subject) {
                        try {
                            const enhancedAnalysis = await enhanceWithOpenAI(analysis, base64);
                            // Merge enhanced details
                            if (enhancedAnalysis.enhancedSubject) {
                                analysis.subject = enhancedAnalysis.enhancedSubject;
                                analysis.enhanced = true;
                            }
                            if (enhancedAnalysis.visualDetails) analysis.visualDetails = enhancedAnalysis.visualDetails;
                            if (enhancedAnalysis.culturalContext) analysis.culturalContext = enhancedAnalysis.culturalContext;
                            if (enhancedAnalysis.collectorNotes) analysis.collectorNotes = enhancedAnalysis.collectorNotes;
                            console.log('Enhanced subject:', analysis.subject);
                        } catch (error) {
                            console.log('OpenAI enhancement skipped:', error.message);
                        }
                    }
                    
                    const orientation = await getImageOrientation(file);
                    const newFilename = generateSmartFilename(analysis, orientation, i);
                    const marketplaceData = generateMarketplaceData(analysis, file.name, newFilename, i);
                    
                    processedData.push({
                        ...marketplaceData,
                        originalFile: file,
                        base64: base64,
                        imageUrl: URL.createObjectURL(file)
                    });
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    const orientation = await getImageOrientation(file);
                    const newFilename = `artwork_${String(i + 1).padStart(3, '0')}_${orientation}.jpg`;
                    processedData.push({
                        ...generateDefaultData(file.name, newFilename),
                        originalFile: file,
                        imageUrl: URL.createObjectURL(file)
                    });
                }
            }
            
            updateProgress(100, 'Complete!');
            displayResults();
            
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('processBtn').disabled = false;
                showMessage(`✅ Successfully processed ${processedData.length} images with all 34 marketplace fields!`, 'success');
            }, 1000);
        }
        
        async function enhanceWithOpenAI(geminiAnalysis, base64) {
            try {
                const prompt = `You are an expert art appraiser analyzing a ${geminiAnalysis.artist} artwork featuring ${geminiAnalysis.subject}.
                
                Based on this ${geminiAnalysis.artist} piece, provide enhanced details:
                1. Specific visual elements visible in the image
                2. Cultural references and significance
                3. Collector appeal points
                4. Market positioning
                5. Detailed color palette
                6. Artistic techniques used
                
                ${geminiAnalysis.artist === 'Death NYC' ? 'Death NYC is known for dollar bill collages with pop culture icons, often featuring vintage imagery mixed with contemporary subjects.' : ''}
                ${geminiAnalysis.artist === 'Shepard Fairey' ? 'Shepard Fairey created OBEY and uses propaganda-style imagery with bold graphics and political messages.' : ''}
                
                Return as JSON with fields: {enhancedSubject, visualDetails, culturalContext, collectorNotes, colorPalette, techniques, marketValue}`;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-vision-preview',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    { 
                                        type: 'image_url', 
                                        image_url: {
                                            url: `data:image/jpeg;base64,${base64}`,
                                            detail: 'high'
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OpenAI API error');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Parse enhanced details
                let enhanced = {};
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        enhanced = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.log('Could not parse OpenAI response');
                }
                
                // Merge with Gemini analysis
                return {
                    ...geminiAnalysis,
                    subject: enhanced.enhancedSubject || geminiAnalysis.subject,
                    visualDetails: enhanced.visualDetails || '',
                    culturalContext: enhanced.culturalContext || '',
                    collectorNotes: enhanced.collectorNotes || '',
                    colors: enhanced.colorPalette ? enhanced.colorPalette.split(',').map(c => c.trim()) : geminiAnalysis.colors,
                    techniques: enhanced.techniques || '',
                    marketValue: enhanced.marketValue || '',
                    enhanced: true
                };
                
            } catch (error) {
                console.error('OpenAI enhancement error:', error);
                return geminiAnalysis; // Fall back to original
            }
        }
        
        async function analyzeWithGemini(base64) {
            try {
                const prompt = `Analyze this artwork and identify:
                1. Is it Death NYC (dollar bill collages with pop culture) or Shepard Fairey (OBEY, propaganda style)?
                2. Who/what is the main subject (e.g., Marilyn Monroe, Beatles, Obama)?
                3. What colors are dominant?
                4. What's the condition (Mint/Excellent/Very Good/Good)?
                Return as JSON: {artist, subject, confidence, colors, style, medium, condition}`;
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inline_data: { mime_type: 'image/jpeg', data: base64 } }
                                ]
                            }],
                            generationConfig: {
                                temperature: 0.4,
                                maxOutputTokens: 1024
                            }
                        })
                    }
                );
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                try {
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {}
                
                return {
                    artist: text.includes('Death NYC') ? 'Death NYC' : 
                           text.includes('Shepard Fairey') ? 'Shepard Fairey' : 'Unknown',
                    subject: 'Street Art',
                    confidence: 75,
                    colors: ['multicolor'],
                    style: 'Contemporary Street Art',
                    medium: 'Print',
                    condition: 'Very Good'
                };
                
            } catch (error) {
                console.error('AI error:', error);
                return {
                    artist: 'Unknown',
                    subject: 'Artwork',
                    confidence: 0
                };
            }
        }
        
        function generateSmartFilename(analysis, orientation, index) {
            const artist = (analysis.artist || 'unknown').toLowerCase().replace(/\s+/g, '_');
            const subject = (analysis.subject || 'artwork').toLowerCase().replace(/[^a-z0-9]/g, '_');
            const num = String(index + 1).padStart(3, '0');
            return `${artist}_${subject}_${num}_${orientation}.jpg`;
        }
        
        function generateMarketplaceData(analysis, originalName, newFilename, index) {
            const artist = analysis.artist || 'Unknown';
            const subject = analysis.subject || 'Artwork';
            const condition = analysis.condition || 'Very Good';
            const year = new Date().getFullYear().toString();
            
            // Pricing based on artist (only suggested price, not original)
            let price = '$149.00';
            let shippingFee = '$12.99';
            
            if (artist === 'Death NYC') {
                price = '$299.00';
                shippingFee = '$14.99';
            } else if (artist === 'Shepard Fairey') {
                price = '$599.00';
                shippingFee = '$19.99';
            }
            
            // Generate specific title based on actual detected/enhanced subject
            const title = `${artist} - ${subject} - Original Street Art Print`.substring(0, 80);
            // Use the detected subject for SEO
            const seoTitle = `${artist} ${subject} Street Art | Authentic Contemporary Print`;
            const seoDescription = `Authentic ${artist} artwork featuring ${subject}. Original street art print in ${condition} condition. Perfect for collectors and art enthusiasts. Fast shipping.`;
            
            // Generate professional description with storyline
            const detectedSubject = subject; // Use the actual detected subject
            const description = `**${artist.toUpperCase()} - "${detectedSubject}"**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${artist === 'Death NYC' ? `ABOUT DEATH NYC:
Death NYC is one of the most collected and sought-after contemporary street artists of our generation. Known for their iconic dollar bill collages that merge pop culture with street art, Death NYC has created a unique artistic language that resonates with collectors worldwide. Their works feature meticulously crafted compositions using real currency as the canvas, overlaid with powerful imagery from pop culture, fashion, and contemporary icons.

This artist's work has been exhibited in galleries from New York to Tokyo, with pieces held in private collections of notable celebrities and art collectors. Death NYC's distinctive style combines the rebellious spirit of street art with the precision of fine art, creating pieces that are both culturally relevant and timelessly appealing.` : ''}
${artist === 'Shepard Fairey' ? `ABOUT SHEPARD FAIREY:
Shepard Fairey is a legendary figure in contemporary art, best known for creating the iconic OBEY Giant campaign and the Barack Obama "Hope" poster that became a symbol of a generation. His work is exhibited in major museums worldwide including the Smithsonian, MoMA, and the Victoria and Albert Museum. Fairey's art challenges viewers to question propaganda, advertising, and political messaging through bold graphics and provocative imagery.

As founder of OBEY Clothing and Studio Number One, Fairey has influenced fashion, design, and street culture for over three decades. His works command significant prices at auction and are considered blue-chip investments in the contemporary art market.` : ''}
${artist === 'Unknown' ? `CONTEMPORARY STREET ART MOVEMENT:
This piece represents the vibrant contemporary street art movement that has transformed from underground rebellion to mainstream recognition. Street art has become one of the most collected and fastest-growing segments of the art market, with works by leading artists achieving record prices at major auction houses.` : ''}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**ARTWORK DETAILS:**
• Artist: ${artist}
• Subject: ${detectedSubject}
• STYLE: ${analysis.style || 'Contemporary Street Art'}
• MEDIUM: ${analysis.medium || 'High-Quality Print on Archival Paper'}
• CONDITION: ${condition} - Carefully preserved and stored in protective sleeve
• SIZE: [To be specified]
• COLORS: ${(analysis.colors || ['Vibrant multicolor']).join(', ')}
• YEAR: Circa 2020-2024
• EDITION: Limited availability

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏆 WHY COLLECT THIS PIECE:

✓ INVESTMENT POTENTIAL: Street art has shown consistent appreciation in value, with works by established artists increasing significantly over time
✓ CULTURAL SIGNIFICANCE: Own a piece of contemporary art history that captures the zeitgeist of our era
✓ VERSATILE DISPLAY: Perfect size for home, office, or gallery wall - makes a stunning statement piece
✓ CONVERSATION STARTER: Bold, thought-provoking artwork that guests will admire and discuss
✓ GIFT-WORTHY: An exceptional gift for art lovers, collectors, or anyone who appreciates contemporary culture

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📦 SHIPPING & HANDLING:

• PROFESSIONAL PACKAGING: Your artwork will be carefully wrapped in acid-free tissue paper, placed between protective boards, and shipped in a rigid mailer to ensure it arrives in perfect condition
• FAST SHIPPING: Orders ship within 1 business day via USPS Priority Mail with tracking
• INSURANCE: All shipments are insured for the full value
• INTERNATIONAL: We ship worldwide through eBay's Global Shipping Program
• HANDLING TIME: Same day or next business day dispatch

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💯 AUTHENTICITY & PROVENANCE:

${artist === 'Death NYC' || artist === 'Shepard Fairey' ? `• AUTHENTICITY: Guaranteed authentic ${artist} artwork
• PROVENANCE: From private collection, stored in climate-controlled environment
• VERIFICATION: We stand behind the authenticity of every piece we sell` : `• PROVENANCE: From curated private collection
• QUALITY: Museum-quality materials ensure longevity`}
• CERTIFICATE: Available upon request
• GALLERY LETTER: Documentation can be provided for insurance purposes

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔄 RETURN POLICY & BUYER PROTECTION:

• 30-DAY RETURNS: Full refund if you're not completely satisfied
• CONDITION GUARANTEE: Item exactly as described or your money back
• EBAY PROTECTION: Covered by eBay Money Back Guarantee
• EASY RETURNS: Prepaid return label provided if needed
• QUESTIONS: Message us anytime - we typically respond within hours

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🌟 PERFECT FOR:

• Serious art collectors building their contemporary portfolio
• Interior designers seeking statement pieces
• Gift-givers looking for unique, meaningful presents
• New collectors starting their art journey
• Investors diversifying into tangible assets
• Anyone who appreciates bold, culturally relevant artwork

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 ADDITIONAL NOTES:

• FRAMING: Arrives unframed - standard 11x14 size fits readily available frames
• DISPLAY: Can be framed with or without matting based on preference
• CARE: Keep away from direct sunlight to preserve colors
• STORAGE: If not displaying immediately, store flat in protective sleeve

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💬 FROM THE SELLER:

"We are passionate collectors and dealers specializing in contemporary street art. Every piece in our collection is carefully curated and authenticated. We believe art should be accessible and aim to connect remarkable works with appreciative collectors. Your satisfaction is our top priority, and we're here to answer any questions about this piece or help you find the perfect addition to your collection."

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚡ ACT FAST - LIMITED AVAILABILITY ⚡

Street art pieces are increasingly sought after and quality examples are becoming harder to find. Don't miss this opportunity to add an exceptional work to your collection.

🛒 BUY WITH CONFIDENCE - 100% POSITIVE FEEDBACK - TRUSTED SELLER 🛒

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

TAGS: ${artist} | ${subject} | Street Art | Contemporary Art | Urban Art | Modern Art | Pop Art | Collectible Art | Investment Art | Gallery Wall | Statement Piece | Original Artwork | Limited Edition | Graffiti Art | Museum Quality`;
            
            // Tags
            const tags = [
                artist.toLowerCase().replace(/\s+/g, '-'),
                'street-art',
                subject.toLowerCase().replace(/\s+/g, '-'),
                'contemporary-art',
                'urban-art',
                'collectible',
                'original-print'
            ].filter(t => t).join(', ');
            
            // Return all 34 fields matching Google Sheet
            return {
                sku: `${artist.replace(/\s+/g, '')}-${Date.now().toString().slice(-6)}-${index + 1}`,
                picture: newFilename,
                title: title,
                originalPrice: '',  // Manual entry
                price: price,
                description: description,
                quantity: 1,
                brand: artist === 'Death NYC' || artist === 'Shepard Fairey' ? artist : 'Independent Artist',
                category: 'Art',
                subcategory: 'Art Prints',
                condition: condition,
                color: (analysis.colors || ['Multicolor']).join(', '),
                size: '',  // Hard-coded by user
                weight: '',  // Hard-coded by user
                length: '',  // Hard-coded by user
                width: '',  // Hard-coded by user
                height: '',  // Hard-coded by user
                materials: 'Paper, Archival Ink',
                tags: tags,
                imageUrls: newFilename,
                artist: artist,
                signedBy: artist === 'Death NYC' || artist === 'Shepard Fairey' ? artist : '',
                year: year,
                shippingFee: shippingFee,
                shippingMethod: 'USPS Priority Mail',
                personalization: 'No',
                isDigital: 'No',
                whoMadeIt: artist === 'Death NYC' || artist === 'Shepard Fairey' ? 'The artist' : 'Unknown',
                whenMade: '2020-2024',
                seoTitle: seoTitle,
                seoDescription: seoDescription,
                itemSpecifics: `Type: Print | Artist: ${artist} | Subject: ${subject} | Style: ${analysis.style || 'Street Art'} | Signed: ${artist === 'Death NYC' || artist === 'Shepard Fairey' ? 'Yes' : 'No'}`,
                
                // Additional metadata
                originalName: originalName,
                confidence: analysis.confidence || 75,
                processedDate: new Date().toISOString()
            };
        }
        
        function generateDefaultData(originalName, newFilename) {
            const year = new Date().getFullYear().toString();
            return {
                sku: `ART-${Date.now().toString().slice(-6)}`,
                picture: newFilename,
                title: 'Contemporary Street Art Print - Original Artwork',
                originalPrice: '',  // Manual entry
                price: '$149.00',
                description: `🎨 AUTHENTIC CONTEMPORARY STREET ART - COLLECTIBLE ARTWORK 🎨

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CONTEMPORARY STREET ART MOVEMENT:
This piece represents the vibrant contemporary street art movement that has transformed from underground rebellion to mainstream recognition. Street art has become one of the most collected and fastest-growing segments of the art market, with works by leading artists achieving record prices at major auction houses.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📌 ARTWORK DETAILS:
• STYLE: Contemporary Street Art
• MEDIUM: High-Quality Print
• CONDITION: Good - Well preserved
• SIZE: [To be specified]
• YEAR: 2020-2024

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏆 WHY COLLECT THIS PIECE:
✓ Part of the contemporary art movement
✓ Perfect for modern interiors
✓ Standard size for easy framing
✓ Conversation starter
✓ Affordable art investment

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📦 SHIPPING & HANDLING:
• Professional packaging in protective materials
• Ships within 1 business day
• USPS Priority Mail with tracking
• Insurance included

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔄 RETURN POLICY:
• 30-day returns accepted
• Full refund if not satisfied
• Protected by eBay guarantee

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🛒 BUY WITH CONFIDENCE - SATISFACTION GUARANTEED 🛒`,
                quantity: 1,
                brand: 'Independent Artist',
                category: 'Art',
                subcategory: 'Art Prints',
                condition: 'Good',
                color: 'Multicolor',
                size: '',  // Hard-coded by user
                weight: '',  // Hard-coded by user
                length: '',  // Hard-coded by user
                width: '',  // Hard-coded by user
                height: '',  // Hard-coded by user
                materials: 'Paper',
                tags: 'street-art, contemporary',
                imageUrls: newFilename,
                artist: 'Unknown',
                signedBy: '',
                year: year,
                shippingFee: '$12.99',
                shippingMethod: 'USPS Priority Mail',
                personalization: 'No',
                isDigital: 'No',
                whoMadeIt: 'Unknown',
                whenMade: '2020-2024',
                seoTitle: 'Contemporary Street Art Print',
                seoDescription: 'Original street art print for collectors',
                itemSpecifics: 'Type: Print',
                originalName: originalName,
                confidence: 0
            };
        }
        
        function displayResults() {
            // Update stats
            let deathCount = 0;
            let shepardCount = 0;
            let totalPrice = 0;
            
            processedData.forEach(item => {
                if (item.artist === 'Death NYC') deathCount++;
                else if (item.artist === 'Shepard Fairey') shepardCount++;
                totalPrice += parseFloat(item.price.replace('$', ''));
            });
            
            document.getElementById('totalCount').textContent = processedData.length;
            document.getElementById('deathCount').textContent = deathCount;
            document.getElementById('shepardCount').textContent = shepardCount;
            document.getElementById('avgPrice').textContent = '$' + Math.round(totalPrice / processedData.length);
            
            // Display table
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            processedData.forEach((item, index) => {
                // Count filled fields (26 auto-filled fields - excluding manual entries)
                const requiredFields = ['sku', 'picture', 'title', 'price', 'description',
                    'quantity', 'brand', 'category', 'subcategory', 'condition', 'color', 'materials', 
                    'tags', 'imageUrls', 'artist', 'signedBy', 'year', 'shippingFee', 'shippingMethod', 
                    'personalization', 'isDigital', 'whoMadeIt', 'whenMade', 
                    'seoTitle', 'seoDescription', 'itemSpecifics'];
                
                let filledFields = 0;
                requiredFields.forEach(field => {
                    if (item[field] !== null && item[field] !== undefined && item[field] !== '' && item[field] !== 0) {
                        filledFields++;
                    }
                });
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><img src="${item.imageUrl}" class="thumbnail" alt="${item.originalName}" onclick="showDetails(${index})"></td>
                    <td><input type="text" class="editable" value="${item.picture}" 
                        onchange="updateData(${index}, 'picture', this.value)"></td>
                    <td>${item.artist}</td>
                    <td><input type="text" class="editable" value="${item.title}" 
                        onchange="updateData(${index}, 'title', this.value)" maxlength="80"></td>
                    <td><input type="text" class="editable" value="${item.price}" 
                        onchange="updateData(${index}, 'price', this.value)"></td>
                    <td><span class="field-count-badge">${filledFields}/26</span></td>
                    <td>
                        <button onclick="showDetails(${index})" class="btn-search" style="margin-right: 5px;">View</button>
                        <button onclick="searchSimilar(${index})" class="btn-search" style="background: linear-gradient(135deg, #ff6b6b, #ff8787); padding: 8px 20px;" title="Search eBay/Google for similar art">
                            🔍 Search Similar
                        </button>
                    </td>
                `;
            });
        }
        
        function updateData(index, field, value) {
            processedData[index][field] = value;
        }
        
        function showDetails(index) {
            const item = processedData[index];
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            
            // Count filled fields (26 auto-filled fields - excluding manual entries)
            const requiredFields = ['sku', 'picture', 'title', 'price', 'description',
                'quantity', 'brand', 'category', 'subcategory', 'condition', 'color', 'materials', 
                'tags', 'imageUrls', 'artist', 'signedBy', 'year', 'shippingFee', 'shippingMethod', 
                'personalization', 'isDigital', 'whoMadeIt', 'whenMade', 
                'seoTitle', 'seoDescription', 'itemSpecifics'];
            
            let filledCount = 0;
            requiredFields.forEach(field => {
                if (item[field] !== null && item[field] !== undefined && item[field] !== '' && item[field] !== 0) {
                    filledCount++;
                }
            });
            
            let detailHTML = `
                <div class="detail-grid">
                    <div>
                        <img src="${item.imageUrl}" class="detail-image" alt="${item.picture}">
                        <div style="margin-top: 15px;">
                            <div class="field-group">
                                <div class="field-label">Fields Completed</div>
                                <div class="field-value" style="font-size: 24px; color: #00ff88;">${filledCount}/26</div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-fields">
            `;
            
            // Display all 34 fields
            const fieldGroups = {
                'Identification': ['sku', 'picture'],
                'Basic Info': ['title', 'originalPrice', 'price', 'description'],
                'Inventory': ['quantity', 'brand', 'category', 'subcategory'],
                'Physical Details': ['condition', 'color', 'size', 'weight', 'length', 'width', 'height', 'materials'],
                'Marketing': ['tags', 'imageUrls'],
                'Artist Info': ['artist', 'signedBy', 'year'],
                'Shipping': ['shippingFee', 'shippingMethod'],
                'Product Details': ['personalization', 'isDigital', 'whoMadeIt', 'whenMade'],
                'SEO': ['seoTitle', 'seoDescription'],
                'eBay Specifics': ['itemSpecifics']
            };
            
            Object.entries(fieldGroups).forEach(([groupName, fields]) => {
                detailHTML += `<div style="grid-column: span 2;"><h3 style="color: #00ccff; margin: 15px 0; border-bottom: 1px solid rgba(0,204,255,0.3); padding-bottom: 5px;">${groupName}</h3></div>`;
                fields.forEach(field => {
                    const value = item[field];
                    if (value !== undefined && value !== null) {
                        const fieldName = field.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        detailHTML += `
                            <div class="field-group">
                                <div class="field-label">${fieldName}</div>
                                <div class="field-value">${value || 'Not set'}</div>
                            </div>
                        `;
                    }
                });
            });
            
            detailHTML += `
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="copyItemData(${index})" class="btn-download">📋 Copy All Data</button>
                    <button onclick="downloadSingleImage(${index})" class="btn-download">💾 Download Renamed Image</button>
                </div>
            `;
            
            modalBody.innerHTML = detailHTML;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            const searchModal = document.getElementById('searchModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == searchModal) {
                searchModal.style.display = 'none';
            }
        }
        
        async function searchSimilar(index) {
            const item = processedData[index];
            // Use the enhanced subject if available for more specific searches
            const searchQuery = item.enhancedSubject ? 
                `${item.artist} ${item.enhancedSubject}` : 
                `${item.artist} ${item.subject || item.title}`;
            
            showMessage(`Searching for: ${searchQuery}...`, 'success');
            
            const modal = document.getElementById('searchModal');
            const modalBody = document.getElementById('searchModalBody');
            
            // Show loading
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🔍</div>
                    <h3 style="color: #00ff88;">Searching marketplaces...</h3>
                    <p style="color: #999; margin-top: 10px;">Finding similar artworks...</p>
                </div>
            `;
            modal.style.display = 'block';
            
            // Create search links with the specific artwork name
            const ebaySearchLink = `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(searchQuery)}&_sacat=550&_sop=15`; // Sort by price + shipping: lowest first
            const googleSearchLink = `https://www.google.com/search?q=${encodeURIComponent(searchQuery + ' art for sale')}&tbm=isch`;
            const etsySearchLink = `https://www.etsy.com/search?q=${encodeURIComponent(searchQuery)}`;
            const mercariSearchLink = `https://www.mercari.com/search/?keyword=${encodeURIComponent(searchQuery)}`;
            
            // Generate market analysis based on artist
            let marketAnalysis = {
                priceRange: '$50-$500',
                demand: 'Medium',
                strategy: 'Price competitively based on condition and authenticity',
                tips: ['Check sold listings', 'Compare conditions', 'Verify authenticity']
            };
            
            // Adjust based on artist
            if (item.artist === 'Death NYC') {
                marketAnalysis.priceRange = '$150-$500';
                marketAnalysis.demand = 'High';
                marketAnalysis.strategy = 'Death NYC pieces typically sell for $200-$400 depending on subject and condition';
            } else if (item.artist === 'Shepard Fairey') {
                marketAnalysis.priceRange = '$300-$1500';
                marketAnalysis.demand = 'Very High';
                marketAnalysis.strategy = 'Shepard Fairey works command premium prices, especially signed pieces';
            }
            
            // Try to enhance with AI if available
            try {
                const marketPrompt = `Based on: ${item.artist} artwork featuring ${item.subject || item.title}
                Suggested price: ${item.price}
                Provide realistic market insights as JSON: {priceRange, demand, strategy}`;
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: marketPrompt }]
                            }],
                            generationConfig: {
                                temperature: 0.4,
                                maxOutputTokens: 512
                            }
                        })
                    }
                );
                
                const data = await response.json();
                const analysisText = data.candidates[0].content.parts[0].text;
                try {
                    const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        // Update with AI insights if valid
                        if (parsed.priceRange && typeof parsed.priceRange === 'string') {
                            marketAnalysis.priceRange = parsed.priceRange;
                        }
                        if (parsed.demand && typeof parsed.demand === 'string') {
                            marketAnalysis.demand = parsed.demand;
                        }
                        if (parsed.strategy && typeof parsed.strategy === 'string') {
                            marketAnalysis.strategy = parsed.strategy;
                        }
                    }
                } catch (e) {
                    console.log('Using default market analysis for', item.artist);
                }
                
                // Update modal with results
                modalBody.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="color: #00ff88; margin-bottom: 15px;">📊 Market Analysis</h3>
                            <div class="field-group">
                                <div class="field-label">Typical Price Range</div>
                                <div class="field-value" style="color: #00ff88; font-weight: bold;">${marketAnalysis.priceRange}</div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Market Demand</div>
                                <div class="field-value" style="color: ${marketAnalysis.demand === 'High' || marketAnalysis.demand === 'Very High' ? '#00ff88' : marketAnalysis.demand === 'Low' ? '#ff6464' : '#ffcc00'}; font-weight: bold;">
                                    ${marketAnalysis.demand}
                                </div>
                            </div>
                            <div class="field-group">
                                <div class="field-label">Pricing Strategy</div>
                                <div class="field-value" style="font-size: 13px; line-height: 1.4;">${marketAnalysis.strategy}</div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: #00ccff; margin-bottom: 15px;">🔗 Search for: "${searchQuery}"</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <a href="${ebaySearchLink}" target="_blank" class="btn-download" style="display: block; text-align: center; text-decoration: none; background: linear-gradient(135deg, #f5a623, #f76b1c);">
                                    <div style="font-size: 24px;">🛍️</div>
                                    eBay Results
                                </a>
                                <a href="${googleSearchLink}" target="_blank" class="btn-download" style="display: block; text-align: center; text-decoration: none; background: linear-gradient(135deg, #4285f4, #34a853);">
                                    <div style="font-size: 24px;">🔍</div>
                                    Google Images
                                </a>
                                <a href="${etsySearchLink}" target="_blank" class="btn-download" style="display: block; text-align: center; text-decoration: none; background: linear-gradient(135deg, #f56223, #f1641e);">
                                    <div style="font-size: 24px;">🎨</div>
                                    Etsy Results
                                </a>
                                <a href="${mercariSearchLink}" target="_blank" class="btn-download" style="display: block; text-align: center; text-decoration: none; background: linear-gradient(135deg, #ee4d2d, #ff6533);">
                                    <div style="font-size: 24px;">📦</div>
                                    Mercari Results
                                </a>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <p style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">💡 Pro Tips:</p>
                                <ul style="color: #ccc; font-size: 14px; margin-left: 20px;">
                                    <li>eBay: Check "Sold" listings to see actual sale prices</li>
                                    <li>Google: Find similar artworks and pricing trends</li>
                                    <li>Etsy: Compare handmade/vintage pricing</li>
                                    <li>Mercari: Check recent sales and active listings</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="closeSearchModal()" class="btn-download">Close</button>
                    </div>
                `;
                
            } catch (error) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #ff6464;">Search links ready!</h3>
                        <div style="margin-top: 20px;">
                            <a href="${ebaySearchLink}" target="_blank" class="btn-download" style="display: inline-block; text-decoration: none; margin: 10px;">
                                🛍️ Search on eBay
                            </a>
                            <a href="${googleSearchLink}" target="_blank" class="btn-download" style="display: inline-block; text-decoration: none; margin: 10px;">
                                🔍 Search on Google
                            </a>
                        </div>
                        <button onclick="closeSearchModal()" style="margin-top: 20px; padding: 10px 20px;">Close</button>
                    </div>
                `;
            }
        }
        
        function copyItemData(index) {
            const item = processedData[index];
            const text = Object.entries(item)
                .filter(([key]) => !['originalFile', 'base64', 'imageUrl'].includes(key))
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
            
            navigator.clipboard.writeText(text);
            showMessage('Copied to clipboard!', 'success');
        }
        
        function downloadSingleImage(index) {
            const item = processedData[index];
            const blob = item.originalFile;
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = item.picture;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`Downloaded: ${item.picture}`, 'success');
        }
        
        function exportFullCSV() {
            // Headers matching Google Sheet exactly
            const headers = [
                'SKU', 'Picture', 'Title', 'Original Price', 'Price', 'Description',
                'Quantity', 'Brand', 'Category', 'Subcategory', 'Condition', 'Color',
                'Size', 'Weight', 'Length', 'Width', 'Height', 'Materials', 'Tags',
                'Image URLs', 'Artist', 'Signed By', 'Year', 'Shipping Fee',
                'Shipping Method', 'Personalization', 'Is Digital', 'Who Made It',
                'When Made', 'SEO Title', 'SEO Description', 'Item Specifics'
            ];
            
            let csv = headers.join(',') + '\n';
            
            processedData.forEach(item => {
                const row = [
                    item.sku,
                    item.picture,
                    `"${item.title}"`,
                    item.originalPrice,
                    item.price,
                    `"${item.description.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    item.quantity,
                    item.brand,
                    item.category,
                    item.subcategory,
                    item.condition,
                    item.color,
                    item.size,
                    item.weight,
                    item.length,
                    item.width,
                    item.height,
                    item.materials,
                    `"${item.tags}"`,
                    item.imageUrls,
                    item.artist,
                    item.signedBy,
                    item.year,
                    item.shippingFee,
                    item.shippingMethod,
                    item.personalization,
                    item.isDigital,
                    item.whoMadeIt,
                    item.whenMade,
                    `"${item.seoTitle}"`,
                    `"${item.seoDescription}"`,
                    `"${item.itemSpecifics}"`
                ];
                csv += row.join(',') + '\n';
            });
            
            downloadFile(csv, 'marketplace-listings.csv', 'text/csv');
            showMessage('✅ Downloaded CSV with all 34 marketplace fields!', 'success');
        }
        
        async function downloadRenamedImages() {
            showMessage('Downloading renamed images...', 'success');
            
            for (let i = 0; i < processedData.length; i++) {
                const item = processedData[i];
                const blob = item.originalFile;
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = item.picture;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            showMessage(`✅ Downloaded ${processedData.length} renamed images!`, 'success');
        }
        
        function copyToClipboard() {
            let text = 'MARKETPLACE LISTINGS DATA (34 Fields)\n' + '='.repeat(50) + '\n\n';
            
            processedData.forEach((item, i) => {
                text += `ITEM ${i + 1}: ${item.picture}\n`;
                text += `SKU: ${item.sku}\n`;
                text += `Artist: ${item.artist}\n`;
                text += `Title: ${item.title}\n`;
                text += `Price: ${item.price}\n`;
                text += `Category: ${item.category}/${item.subcategory}\n`;
                text += '-'.repeat(30) + '\n\n';
            });
            
            navigator.clipboard.writeText(text);
            showMessage('✅ All data copied to clipboard!', 'success');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function getImageOrientation(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    resolve(img.width > img.height ? 'H' : 'V');
                };
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function imageToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height && width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        } else if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = text || Math.round(percent) + '%';
        }
        
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message ' + type;
            setTimeout(() => {
                message.className = 'message';
            }, 5000);
        }
        
        function showWelcomeModal() {
            document.getElementById('welcomeModal').style.display = 'block';
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }
            
            if (!apiKey.startsWith('AIzaSy') || apiKey.length < 39) {
                alert('Invalid API key format. It should start with "AIzaSy" and be 39 characters long.');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('gemini_key', apiKey);
            GEMINI_KEY = apiKey;
            
            // Close modal
            document.getElementById('welcomeModal').style.display = 'none';
            
            // Show success message
            showMessage('✅ API Key saved successfully! You can now process images.', 'success');
        }
        
        // Add settings button to reset API key
        function resetApiKey() {
            if (confirm('Reset API key and enter a new one?')) {
                localStorage.removeItem('gemini_key');
                GEMINI_KEY = '';
                showWelcomeModal();
            }
        }
    </script>
</body>
</html>